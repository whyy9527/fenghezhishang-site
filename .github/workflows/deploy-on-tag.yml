name: Build and Deploy (on tag)

on:
  push:
    # only run when a tag is pushed (e.g. v1.0.0)
    tags:
      - 'v*'

jobs:
  build:
    name: Build static site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        run: npm install -g pnpm@9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          NEXT_TELEMETRY_DISABLED: 1
        run: pnpm build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-site
          path: out

  deploy:
    name: Deploy to Alibaba OSS (using marketplace action)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: static-site
          path: ./out

      # Use YangHanlin/oss-deployment-action which wraps ossutil and supports delete-first.
      # Configure these repository secrets before running: OSS_ENDPOINT, OSS_ACCESS_KEY_ID, OSS_ACCESS_KEY_SECRET, OSS_BUCKET
      - name: Deploy to Aliyun OSS (sync, delete-first)
        uses: YangHanlin/oss-deployment-action@v1
        with:
          # OSS endpoint, e.g. 'oss-cn-hangzhou.aliyuncs.com'
          oss-endpoint: ${{ secrets.OSS_ENDPOINT }}
          oss-accesskey-id: ${{ secrets.OSS_ACCESS_KEY_ID }}
          oss-accesskey-secret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          # Target bucket/path in the form: oss://<BUCKET>/<PATH>
          # delete-first: true 会删除目标路径下的所有文件，请确保 oss-path 指向正确的桶/目录，避免误删重要数据。常见做法是把网站放在 bucket 的子目录（如 oss://my-bucket/site/），而非根目录 /，以降低误操作风险。
          oss-path: oss://${{ secrets.OSS_BUCKET }}/
          # Deploy from the exported Next.js out/ directory
          local-path: ./out
          # Delete remote files under oss-path before upload (full sync)
          delete-first: true
          # Optional: enable debug by setting ACTIONS_STEP_DEBUG secret
          debug: ${{ secrets.ACTIONS_STEP_DEBUG }}
